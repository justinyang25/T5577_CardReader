C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE MIAN
OBJECT MODULE PLACED IN .\Objects\mian.obj
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE Scr\mian.c BROWSE INCDIR(.\Header) DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\mian.lst) TABS(2) OBJECT(.\Objects\mian.obj)

line level    source

   1          #include"STC8F.h"
   2          #include"IntPut_IO.h"
   3          #include"Uart.h"
   4          #include"EM41xx.h"
   5          #include"EMReadWriteCard.h"
   6          #include"CopyEM4100.h"
   7          #include"CRC16.h"
   8          #include"T5557.h"
   9          
  10          bit LED_flag = 0;
  11          unsigned int  Time_Up = 0;
  12          unsigned int  EM_Wait = 0;
  13          
  14          void Delay125us(void)     //@24.000MHz
  15          {
  16   1          unsigned char i, j;
  17   1        
  18   1          _nop_();
  19   1          _nop_();
  20   1          i = 4;
  21   1          j = 128;
  22   1          do
  23   1          {
  24   2              while (--j);
  25   2          }while (--i);
  26   1      }
  27          void Delay100ms(void)    //@22.1184MHz
  28          {
  29   1          unsigned char i, j, k;
  30   1      
  31   1          i = 12;
  32   1          j = 57;
  33   1          k = 122;
  34   1          do
  35   1          {
  36   2              do
  37   2              {
  38   3                  while (--k);
  39   3              }while (--j);
  40   2          }while (--i);
  41   1      }
  42          //========================================================================
  43          // º¯Êý: void BP_BP(unsigned char Counter,bit Mode) 
  44          // ÃèÊö: ·äÃùÆ÷º¯Êý
  45          // ²ÎÊý: Counter£º ´ÎÊý   Mode£º1³¤Ïì 0¶ÌÏìº
  46          // ·µ»Ø: 
  47          // °æ±¾: V1.0, 2017-9-23
  48          //========================================================================
  49          void BP_BP(unsigned char Counter,bit Mode)  
  50          {
  51   1          unsigned char x;
  52   1          unsigned int y,CheckCount = 0;
  53   1        
  54   1          CheckCount = 200;
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 2   

  55   1          if(Mode)  CheckCount = 1000;
  56   1        
  57   1          EA = 0;
  58   1          for(x = 0;x < Counter;x ++)
  59   1          {
  60   2              for(y = 0;y < CheckCount;y ++)
  61   2              {
  62   3                  BP = !BP;
  63   3                  Delay125us();
  64   3              }
  65   2              BP = 0;
  66   2              if(x == (Counter - 1))  break;
  67   2              Delay100ms();
  68   2          }
  69   1          EA = 1; 
  70   1      }
  71          
  72          void Timer3InIt(void)    //¶¨Ê±1ms
  73          {  
  74   1          T3L = 0x30;          //65536-11.0592M/12/1000
  75   1          T3H = 0xF8;
  76   1          T4T3M = 0x08;        //Æô¶¯¶¨Ê±Æ÷ 12TÄ£Ê½
  77   1          IE2 = ET3;           //Ê¹ÄÜ¶¨Ê±Æ÷ÖÐ¶Ï
  78   1      }
  79          void SYS_InIt(void)
  80          {
  81   1          BP = 0;
  82   1          LED = 0;
  83   1          LED1 = 1;
  84   1          T1CLK = 0;
  85   1          INPORT = 1;
  86   1        
  87   1          P1M0 = 0x4C;           //0100 1100
  88   1          P1M1 = 0x00;  
  89   1          P3M0 = 0x12;           //0001 0010
  90   1          P3M1 = 0x00;           //0000 0000
  91   1        
  92   1          UartInit(); 
  93   1          Timer3InIt();
  94   1          T1Clk_Out(125);        //Ê±ÖÓÊä³ö125K
  95   1          RFID_Timer0InIt();     //¶¨Ê±Æ÷0³õÊ¼»¯£¬ÓÃÓÚRFID½ÅµçÆ½¼ÆÊý
  96   1          Carrier_Off();
  97   1          BP_BP(1,0);
  98   1      }
  99          
 100          void UartDriver(void)      //´®¿Ú½ÓÊÕÊý¾Ý´¦Àí
 101          {
 102   1          union 
 103   1          {
 104   1              unsigned int  _uint;          
 105   1              unsigned char B[2];
 106   1          }xdata CRC16_Base;  
 107   1          
 108   1          union 
 109   1          {
 110   1              unsigned long uL;         
 111   1              unsigned char B[4];
 112   1          }PassData;
 113   1          
 114   1          union 
 115   1          {
 116   1              unsigned long uL;         
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 3   

 117   1              unsigned char B[4];
 118   1          }BankData;    
 119   1          
 120   1          unsigned char i,j; 
 121   1          unsigned char Uart_Len;
 122   1          unsigned char xdata Uart_Buff[60];
 123   1          unsigned char xdata ListEM4100UID[5];
 124   1          unsigned char Read_PLL = 0;
 125   1          unsigned char UserPassFlag = 0;
 126   1          unsigned char BankLock = 0;
 127   1          unsigned char BankLock_bit = 0;
 128   1          
 129   1          if(cmdArrived)  
 130   1          {
 131   2              cmdArrived = 0;
 132   2              Uart_Len = UartRead(Uart_Buff, sizeof(Uart_Buff));  //½«½ÓÊÕµ½Êý¾Ý¶ÁÈ¡µ½»º´æ
 133   2              if((Uart_Buff[0] == 0xAA) && (Uart_Buff[Uart_Len - 1] == 0xEE)) //ºÏ¸ñµÄÊý¾ÝÍ·ºÍÎ²
 134   2              {
 135   3                  CRC16_Base._uint = GetCRC16(Uart_Buff, Uart_Len - 3);  
 136   3                  if((Uart_Buff[Uart_Len - 2] == CRC16_Base.B[0]) && (Uart_Buff[Uart_Len - 3] == CRC16_Base.B[1])) //
             -CRC16Ð£ÑéÕýÈ·
 137   3                  {
 138   4                      LED = 1;
 139   4                      if((Uart_Buff[1] == 0xFF) && (Uart_Buff[2] == 0xFF))   //Áª»ú
 140   4                      {
 141   5                          LED_flag = 1;
 142   5                          BP_BP(1,0);
 143   5                      }
 144   4                      else
 145   4                      {
 146   5                          switch(Uart_Buff[1])
 147   5                          {
 148   6                              case 0xF0:            //¶Á
 149   6                                        Read_PLL = Uart_Buff[2];      //¶Á¿¨ËÙÂÊ
 150   6                                        UserPassFlag = Uart_Buff[4];  //ÊÇ·ñ±£»¤¶Á 0 Õý³£ 1±£»¤
 151   6                                        for(i = 0; i < 4; i ++)  PassData.B[i] = Uart_Buff[i + 5];  //ÃÜÂë
 152   6                                        if(Uart_Buff[3] & 0x10)   //µÚ1Ò³
 153   6                                        {   
 154   7                                            Uart_Buff[1] = 0xF0;  //·µ»Ø¶ÁµÚÒ»Ò³±ê¼Ç 0xF0
 155   7                                            Uart_Buff[2] = 0;
 156   7                                            Uart_Len = 4;                                   
 157   7                                            switch(Uart_Buff[3])
 158   7                                            {
 159   8                                                case 0x12:        //¿é1
 160   8                                                          Uart_Buff[2] = T5557Read_Block(1,1,UserPassFlag,PassData.uL,Read_PLL);
 161   8                                                          if(Uart_Buff[2])
 162   8                                                          {
 163   9                                                              for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = T57_Buff[i];
 164   9                                                              BP_BP(1,0);
 165   9                                                          }
 166   8                                                          else
 167   8                                                          {
 168   9                                                              for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = 0;
 169   9                                                              BP_BP(2,0);                                                       
 170   9                                                          }
 171   8                                                        break;
 172   8                                                case 0x14:        //¿é2
 173   8                                                          Uart_Buff[2] = T5557Read_Block(1,2,UserPassFlag,PassData.uL,Read_PLL);
 174   8                                                          if(Uart_Buff[2])
 175   8                                                          {
 176   9                                                              for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = T57_Buff[i];
 177   9                                                              BP_BP(1,0);
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 4   

 178   9                                                          }
 179   8                                                          else
 180   8                                                          {
 181   9                                                              for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = 0;
 182   9                                                              BP_BP(2,0);                                                       
 183   9                                                          }                                         
 184   8                                                        break;  
 185   8                                                case 0x16:        //µÚ1Ò³ ËùÓÐ¿é
 186   8                                                          Uart_Buff[2] = T5557ReadPage(1,Read_PLL);
 187   8                                                          if(Uart_Buff[2])
 188   8                                                          {
 189   9                                                              for(i = 0; i < 8; i ++)  Uart_Buff[Uart_Len ++] = T57_Buff[i];
 190   9                                                              BP_BP(1,0);
 191   9                                                          }
 192   8                                                          else
 193   8                                                          {
 194   9                                                              for(i = 0; i < 8; i ++)  Uart_Buff[Uart_Len ++] = 0;
 195   9                                                              BP_BP(2,0);                                                       
 196   9                                                          }                                           
 197   8                                                        break;                                                  
 198   8                                            }
 199   7                                            CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 200   7                                            Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 201   7                                            Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 202   7                                            Uart_Buff[Uart_Len ++] = 0xEE;
 203   7                                            UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 204   7                                        }
 205   6                                        else       //µÚ0Ò³
 206   6                                        {
 207   7                                            Uart_Buff[1] = 0xF0;  //·µ»Ø¶ÁµÚÒ»Ò³±ê¼Ç 0xF0
 208   7                                            Uart_Buff[2] = 0;
 209   7                                            Uart_Buff[3] = Uart_Buff[3] & 0x0F;
 210   7                                              
 211   7                                            if(Uart_Buff[3] == 0x0F) //¶ÁËùÓÐ¿é
 212   7                                            {
 213   8                                                if(UserPassFlag)     //±£»¤¶Á
 214   8                                                {
 215   9                                                    for(i = 1; i < 7; i ++)  //¶Á1 - 6¿é
 216   9                                                    {
 217  10                                                        Uart_Len = 4;
 218  10                                                        Uart_Buff[2] = T5557Read_Block(0,i,UserPassFlag,PassData.uL,Read_PLL);  
 219  10                                                        if(Uart_Buff[2])
 220  10                                                        {
 221  11                                                            for(j = 0; j < 4; j ++)  Uart_Buff[Uart_Len ++] = T57_Buff[j];
 222  11                                                            BP_BP(1,0);                                                     
 223  11                                                        }
 224  10                                                        else
 225  10                                                        {
 226  11                                                            for(j = 0; j < 4; j ++)  Uart_Buff[Uart_Len ++] = 0;
 227  11                                                            BP_BP(2,0);                                                   
 228  11                                                        }
 229  10                                                        Uart_Buff[3] = i;   //µØÖ·
 230  10                                                        CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 231  10                                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 232  10                                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 233  10                                                        Uart_Buff[Uart_Len ++] = 0xEE;
 234  10                                                        UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 235  10                                                        for(j = 0; j < 4; j ++) DelayNus(50000);  
 236  10                                                    }
 237   9                                                }
 238   8                                                else              //Õý³£¶Á
 239   8                                                {
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 5   

 240   9                                                    Uart_Buff[2] = T5557ReadPage(0,Read_PLL);    //¶Á0Ò³
 241   9                                                    Uart_Len = 4;
 242   9                                                    if(Uart_Buff[2])
 243   9                                                    {
 244  10                                                        for(i = 0; i < 28; i ++)  Uart_Buff[Uart_Len ++] = T57_Buff[i];
 245  10                                                        BP_BP(1,0);
 246  10                                                    }
 247   9                                                    else
 248   9                                                    {
 249  10                                                        for(i = 0; i < 28; i ++)  Uart_Buff[Uart_Len ++] = 0;
 250  10                                                        BP_BP(2,0);                                                       
 251  10                                                    } 
 252   9                                                    CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 253   9                                                    Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 254   9                                                    Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 255   9                                                    Uart_Buff[Uart_Len ++] = 0xEE;
 256   9                                                    UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 257   9                                                }
 258   8                                            }
 259   7                                            else      //¿é¶Á
 260   7                                            { 
 261   8                                                Uart_Len = 4;
 262   8                                                Uart_Buff[2] = T5557Read_Block(0,Uart_Buff[3],UserPassFlag,PassData.uL,Read_PLL);
 263   8                                                if(Uart_Buff[2])
 264   8                                                {
 265   9                                                    for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = T57_Buff[i];
 266   9                                                    BP_BP(1,0);
 267   9                                                }
 268   8                                                else
 269   8                                                {
 270   9                                                    for(i = 0; i < 4; i ++)  Uart_Buff[Uart_Len ++] = 0;
 271   9                                                    BP_BP(2,0);                                                       
 272   9                                                } 
 273   8                                                CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 274   8                                                Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 275   8                                                Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 276   8                                                Uart_Buff[Uart_Len ++] = 0xEE;
 277   8                                                UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 278   8                                            }
 279   7                                        }
 280   6                                        break;
 281   6                              case 0xF1:            //Ð´
 282   6                                        Read_PLL = Uart_Buff[2];      //¶Á¿¨ËÙÂÊ
 283   6                                        for(i = 0; i < 4; i ++)  PassData.B[i]  = Uart_Buff[i + 6]; //ÃÜÂë
 284   6                                        BankLock = Uart_Buff[4];      //¿éËø
 285   6                                        UserPassFlag = Uart_Buff[5];  //ÊÇ·ñ±£»¤Ð´ 0 Õý³£ 1±£»¤
 286   6                                        
 287   6                                        if(Uart_Buff[3] & 0x10)       //µÚ1Ò³
 288   6                                        {
 289   7                                            switch(Uart_Buff[3])
 290   7                                            { 
 291   8                                                case 0x12:for(j = 0; j < 4; j ++)  BankData.B[j] = Uart_Buff[10 + j];    //Êý¾Ý
 292   8                                                          T5557Write_Block(1,1,UserPassFlag,PassData.uL,BankData
             -.uL,BankLock_bit);
 293   8                                                          Uart_Buff[2] = T5557Read_Block(1,1,UserPassFlag,PassDa
             -ta.uL,Read_PLL);   //¶Á³öÊý¾Ý
 294   8                                                          if(Uart_Buff[2])
 295   8                                                          {
 296   9                                                              if((T57_Buff[0] == BankData.B[0]) && 
 297   9                                                                 (T57_Buff[1] == BankData.B[1]) && 
 298   9                                                                 (T57_Buff[2] == BankData.B[2]) && 
 299   9                                                                 (T57_Buff[3] == BankData.B[3])) 
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 6   

 300   9                                                              {
 301  10                                                                   BP_BP(1,0);   
 302  10                                                              }
 303   9                                                              else
 304   9                                                              {
 305  10                                                                   Uart_Buff[2] = 0;
 306  10                                                                   BP_BP(2,0);  
 307  10                                                              }
 308   9                                                          }
 309   8                                                          else
 310   8                                                          {
 311   9                                                              BP_BP(2,0); 
 312   9                                                          }
 313   8                                                          Uart_Len = 4;
 314   8                                                          CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 315   8                                                          Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 316   8                                                          Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 317   8                                                          Uart_Buff[Uart_Len ++] = 0xEE;
 318   8                                                          UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý 
 319   8                                                          break;
 320   8                                                case 0x14:for(j = 0; j < 4; j ++)  BankData.B[j] = Uart_Buff[10 + j];    //Êý¾Ý
 321   8                                                          T5557Write_Block(1,2,UserPassFlag,PassData.uL,BankData
             -.uL,BankLock_bit);
 322   8                                                          Uart_Buff[2] = T5557Read_Block(1,2,UserPassFlag,PassDa
             -ta.uL,Read_PLL);   //¶Á³öÊý¾Ý
 323   8                                                          if(Uart_Buff[2])
 324   8                                                          {
 325   9                                                              if((T57_Buff[0] == BankData.B[0]) && 
 326   9                                                                 (T57_Buff[1] == BankData.B[1]) && 
 327   9                                                                 (T57_Buff[2] == BankData.B[2]) && 
 328   9                                                                 (T57_Buff[3] == BankData.B[3])) 
 329   9                                                              {
 330  10                                                                   BP_BP(1,0);   
 331  10                                                              }
 332   9                                                              else
 333   9                                                              {
 334  10                                                                   Uart_Buff[2] = 0;
 335  10                                                                   BP_BP(2,0);  
 336  10                                                              }
 337   9                                                          }
 338   8                                                          else
 339   8                                                          {
 340   9                                                              BP_BP(2,0); 
 341   9                                                          }
 342   8                                                          Uart_Len = 4;
 343   8                                                          CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 344   8                                                          Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 345   8                                                          Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 346   8                                                          Uart_Buff[Uart_Len ++] = 0xEE;
 347   8                                                          UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý 
 348   8                                                          break;
 349   8                                                case 0x16:BankLock = BankLock >> 1;
 350   8                                                          for(i = 1; i < 3; i ++)       //Ð´1 - 2¿é
 351   8                                                          {
 352   9                                                              BankLock_bit = BankLock & 0x01;
 353   9                                                              for(j = 0; j < 4; j ++)  BankData.B[j] = Uart_Buff[(i - 1) * 4 + 10 + j]; //Êý
             -¾Ý
 354   9                                                              T5557Write_Block(1,i,UserPassFlag,PassData.uL,BankData.uL,BankLock_bit);  
 355   9                                                              BankLock = BankLock >> 1; 
 356   9                                                              Uart_Buff[2] = T5557Read_Block(1,i,UserPassFlag,PassData.uL,Read_PLL);    //¶Á
             -³öÊý¾Ý
 357   9                                                              Uart_Buff[3] = 0x10 | (1 << i);  //µØÖ· µÚÒ»Ò³µÄµØÖ·
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 7   

 358   9                                                              Uart_Len = 4;
 359   9                                                              if(Uart_Buff[2])
 360   9                                                              {
 361  10                                                                  if((T57_Buff[0] == BankData.B[0]) && 
 362  10                                                                     (T57_Buff[1] == BankData.B[1]) && 
 363  10                                                                     (T57_Buff[2] == BankData.B[2]) && 
 364  10                                                                     (T57_Buff[3] == BankData.B[3])) 
 365  10                                                                     {
 366  11                                                                        BP_BP(1,0);   
 367  11                                                                     }
 368  10                                                                     else
 369  10                                                                     {
 370  11                                                                        Uart_Buff[2] = 0;
 371  11                                                                        BP_BP(2,0);
 372  11                                                                     }
 373  10                                                              }
 374   9                                                              else
 375   9                                                              {
 376  10                                                                  BP_BP(2,0);
 377  10                                                              }
 378   9                                                              CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 379   9                                                              Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 380   9                                                              Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 381   9                                                              Uart_Buff[Uart_Len ++] = 0xEE;
 382   9                                                              UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 383   9                                                              for(j = 0; j < 4; j ++) DelayNus(50000);  
 384   9                                                          }
 385   8                                                          break;                                          
 386   8                                            }
 387   7                                        }
 388   6                                        else
 389   6                                        {
 390   7                                            Uart_Buff[3] = Uart_Buff[3] & 0x0F;  //µØÖ·
 391   7                                            if(Uart_Buff[3] == 0x0F)      //Ð´0Ò³ 1 - 7
 392   7                                            {
 393   8                                                BankLock = BankLock >> 1;
 394   8                                                for(i = 1; i < 8; i ++)   //Ö»Ð´1 - 7¿é
 395   8                                                {
 396   9                                                    if((UserPassFlag) && (i == 7))  break; //±£»¤Ð´ Ö»Ð´1 - 6¿é
 397   9                                                  
 398   9                                                    BankLock_bit = BankLock & 0x01;
 399   9                                                    for(j = 0; j < 4; j ++)  BankData.B[j] = Uart_Buff[(i - 1) * 4 + 10 + j]; //Êý¾Ý
 400   9                                                    T5557Write_Block(0,i,UserPassFlag,PassData.uL,BankData.uL,BankLock_bit);  
 401   9                                                    BankLock = BankLock >> 1;   
 402   9                                                    Uart_Buff[2] = T5557Read_Block(0,i,UserPassFlag,PassData.uL,Read_PLL);
 403   9                                                    Uart_Buff[3] = i;  //µØÖ·
 404   9                                                    Uart_Len = 4;
 405   9                                                    if(Uart_Buff[2])
 406   9                                                    {
 407  10                                                         if((T57_Buff[0] == BankData.B[0]) && 
 408  10                                                            (T57_Buff[1] == BankData.B[1]) && 
 409  10                                                            (T57_Buff[2] == BankData.B[2]) && 
 410  10                                                            (T57_Buff[3] == BankData.B[3])) 
 411  10                                                         {
 412  11                                                              BP_BP(1,0);   
 413  11                                                         }
 414  10                                                         else
 415  10                                                         {
 416  11                                                              Uart_Buff[2] = 0;
 417  11                                                              BP_BP(2,0);
 418  11                                                         }
 419  10                                                    }
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 8   

 420   9                                                    else
 421   9                                                    {
 422  10                                                         BP_BP(2,0);
 423  10                                                    }
 424   9                                                    CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 425   9                                                    Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 426   9                                                    Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 427   9                                                    Uart_Buff[Uart_Len ++] = 0xEE;
 428   9                                                    UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 429   9                                                    for(j = 0; j < 4; j ++) DelayNus(50000);  
 430   9                                                }
 431   8                                            }
 432   7                                            else    //¿éÐ´
 433   7                                            {
 434   8                                                for(i = 0; i < 4; i ++)  BankData.B[i] = Uart_Buff[i + 10]; //Êý¾Ý
 435   8                                                T5557Write_Block(0,Uart_Buff[3],UserPassFlag,PassData.uL,BankData.uL,BankLock);   
 436   8                                                if((UserPassFlag) && Uart_Buff[3] == 0x07)  //ÕâÀïµÄÐ´µÄÐÞ¸ÄÃÜÂë ÏÈÔ­ÃÜÂëÐ´£¬ÔÙÓÃÐÂÃÜ
             -Âë¶Á
 437   8                                                {
 438   9                                                    Uart_Buff[2] = T5557Read_Block(0,Uart_Buff[3],UserPassFlag,BankData.uL,Read_PLL); /
             -/ÐÂÃÜÂëÎªÐ´ÈëµÄÊý¾Ý
 439   9                                                }
 440   8                                                else
 441   8                                                {
 442   9                                                    if(Uart_Buff[3] == 0)         //Ð´ÅäÖÃ¿é 
 443   9                                                    {
 444  10                                                        if(BankData.B[3] & 0x10)  //ÃÜÂë±»Ê¹ÄÜ
 445  10                                                        { 
 446  11                                                            Uart_Buff[2] = T5557Read_Block(0,Uart_Buff[3],1,PassData.uL,Read_PLL);  //ÓÃ±£»
             -¤¶Á
 447  11                                                        }   
 448  10                                                        else
 449  10                                                        {
 450  11                                                            Uart_Buff[2] = T5557Read_Block(0,Uart_Buff[3],0,PassData.uL,Read_PLL);  //Õý³£¶
             -Á
 451  11                                                        }
 452  10                                                    }
 453   9                                                    else
 454   9                                                    {
 455  10                                                        Uart_Buff[2] = T5557Read_Block(0,Uart_Buff[3],UserPassFlag,PassData.uL,Read_PLL);
 456  10                                                    }                                         
 457   9                                                }
 458   8                                                Uart_Len = 4;
 459   8                                                if(Uart_Buff[2])
 460   8                                                {
 461   9                                                    if((T57_Buff[0] == BankData.B[0]) &&  //¶Ô¶Á³öµÄÊý¾ÝÑéÖ¤
 462   9                                                       (T57_Buff[1] == BankData.B[1]) && 
 463   9                                                       (T57_Buff[2] == BankData.B[2]) && 
 464   9                                                       (T57_Buff[3] == BankData.B[3])) 
 465   9                                                    {
 466  10                                                        BP_BP(1,0);
 467  10                                                    }
 468   9                                                    else
 469   9                                                    {
 470  10                                                        Uart_Buff[2] = 0;
 471  10                                                        BP_BP(2,0);
 472  10                                                    }
 473   9                                                }
 474   8                                                else
 475   8                                                {
 476   9                                                    BP_BP(2,0);
 477   9                                                } 
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 9   

 478   8                                                CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 479   8                                                Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 480   8                                                Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 481   8                                                Uart_Buff[Uart_Len ++] = 0xEE;
 482   8                                                UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý   
 483   8                                            }
 484   7                                        }   
 485   6                                        break;    
 486   6                              case 0xF2:            //»½ÐÑ
 487   6                                        for(i = 0; i < 4; i ++)  PassData.B[i]  = Uart_Buff[i + 2]; //ÃÜÂë
 488   6                                        Write_Aor(PassData.uL);   //AOR»½ÐÑ
 489   6                                        BP_BP(1,0);
 490   6                                        break;    
 491   6                              case 0xF3:            //¶ÁEM4100
 492   6                                        Carrier_On();         //´ò¿ª´Å³¡  
 493   6                                        EM_Wait = 1000;
 494   6                                        Uart_Buff[1] = 0xF3;
 495   6                                        Uart_Buff[2] = 0;
 496   6                                        Uart_Len = 3; 
 497   6                                        while(EM_Wait > 0)
 498   6                                        {
 499   7                                            if(ReadEM41xxCardNo())
 500   7                                            {
 501   8                                                Uart_Buff[2] = 1;
 502   8                                                BP_BP(1,0);
 503   8                                                for(i = 0; i < 5; i ++) Uart_Buff[Uart_Len ++] = ID[i];
 504   8                                                break;
 505   8                                            }
 506   7                                        }
 507   6                                        if(Uart_Buff[2] == 0)
 508   6                                        {
 509   7                                            BP_BP(2,0);
 510   7                                            for(i = 0; i < 5; i ++) Uart_Buff[Uart_Len ++] = 0;                                     
 511   7                                        }
 512   6                                        CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 513   6                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 514   6                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 515   6                                        Uart_Buff[Uart_Len ++] = 0xEE;
 516   6                                        UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý     
 517   6                                        Carrier_Off();
 518   6                                        break;    
 519   6                              case 0xF4:            //¸´ÖÆEM4100
 520   6                                        for(i = 0; i < 5; i ++)
 521   6                                        {
 522   7                                            Buff[i] = Uart_Buff[3 + i];
 523   7                                            ListEM4100UID[i] = Buff[i];
 524   7                                        }
 525   6                                        switch(Uart_Buff[2])
 526   6                                        {
 527   7                                            case 0:         //»ù¿¨ÊÇ57¿¨
 528   7                                                    T5557CopyEM4100(Buff);
 529   7                                                  break;
 530   7                                            case 1:         //»ù¿¨ÊÇ57¿¨
 531   7                                                    EM4305CopyEM4100(Buff);
 532   7                                                  break;
 533   7                                        }
 534   6                                        Carrier_Off();  
 535   6                                        DelayNus(50000);  
 536   6                                        Carrier_On();         //´ò¿ª´Å³¡  
 537   6                                        EM_Wait = 1000;
 538   6                                        Uart_Buff[1] = 0xF4;
 539   6                                        Uart_Buff[2] = 0;
C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 10  

 540   6                                        Uart_Len = 3; 
 541   6                                        while(EM_Wait > 0)
 542   6                                        {
 543   7                                            if(ReadEM41xxCardNo())   //¶Á³öÀ´±È½Ï
 544   7                                            {
 545   8                                                for(i = 0; i < 5; i ++)
 546   8                                                {
 547   9                                                    if(ID[i] != ListEM4100UID[i])  break;
 548   9                                                }
 549   8                                                if(i == 5)
 550   8                                                {
 551   9                                                    Uart_Buff[2] = 1;
 552   9                                                    BP_BP(1,0);
 553   9                                                    for(i = 0; i < 5; i ++) Uart_Buff[Uart_Len ++] = ID[i];
 554   9                                                }
 555   8                                                break;
 556   8                                            }
 557   7                                        }
 558   6                                        if(Uart_Buff[2] == 0)        //´íÎó
 559   6                                        {
 560   7                                            BP_BP(2,0);
 561   7                                            for(i = 0; i < 5; i ++) Uart_Buff[Uart_Len ++] = 0;                                     
 562   7                                        }
 563   6                                        CRC16_Base._uint = GetCRC16(Uart_Buff,Uart_Len);  
 564   6                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[0];
 565   6                                        Uart_Buff[Uart_Len ++] = CRC16_Base.B[1];
 566   6                                        Uart_Buff[Uart_Len ++] = 0xEE;
 567   6                                        UartWrite(Uart_Buff,Uart_Len);   //·µ»ØÊý¾Ý     
 568   6                                        Carrier_Off();                                  
 569   6                                        break;                            
 570   6                          }
 571   5                      }
 572   4                      LED = 0;
 573   4                  }
 574   3              }  
 575   2          }
 576   1      }
 577          void main(void)
 578          {
 579   1          SYS_InIt();
 580   1        
 581   1          while(1)
 582   1          {
 583   2              UartDriver();               //´®¿Ú½ÓÊÕÊý¾Ý½âÎö
 584   2          }
 585   1      }
 586          
 587          void TM3_Isr() interrupt 19 using 1
 588          {
 589   1          AUXINTIF &= ~0x02;              //Çå³ýÖÐ¶Ï±êÖ¾
 590   1        
 591   1          Uart1RxMonitor(1);
 592   1        
 593   1          if(LED_flag) Time_Up ++;
 594   1          if(Time_Up >= 500)
 595   1          {
 596   2              Time_Up = 0;
 597   2              LED1 = ~LED1;         
 598   2          }
 599   1          if(EM_Wait > 0) EM_Wait --;
 600   1      }

C51 COMPILER V9.55   MIAN                                                                  05/08/2021 16:46:02 PAGE 11  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3244    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      67
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4      15
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
