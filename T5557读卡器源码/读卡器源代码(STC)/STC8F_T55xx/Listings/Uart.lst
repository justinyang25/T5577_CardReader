C51 COMPILER V9.55   UART                                                                  04/30/2021 14:43:20 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\Objects\Uart.obj
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE Scr\Uart.C BROWSE INCDIR(.\Header) DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\Uart.lst) TABS(2) OBJECT(.\Objects\Uart.obj)

line level    source

   1          #include"STC8F.h"
   2          #include"IntPut_IO.h"
   3          
   4          bit flagOnceTxd = 0;            //µ¥´Î·¢ËÍÍê³É±êÖ¾,¼´·¢ËÍÍêÒ»¸ö×Ö½Ú
   5          bit cmdArrived = 0;             //ÃüÁîµ½´ï±êÖ¾,¼´½ÓÊÕµ½Êı¾İ
   6          unsigned char cntRxd = 0;
   7          unsigned char xdata bufRxd[80];       //½ÓÊÕ»º³åÇø
   8          
   9          void UartInit(void)
  10          {
  11   1          SCON = 0x50;
  12   1          T2L = BRT;
  13   1          T2H = BRT >> 8;
  14   1          AUXR = 0x15;
  15   1          ES = 1;         //¿ª´®¿ÚÖĞ¶Ï
  16   1          EA = 1;         //¿ª×ÜÖĞ¶Ï
  17   1      }
  18          
  19          //========================================================================
  20          // º¯Êı: unsigned char Uart1Read(unsigned char *buf, unsigned char len)
  21          // ÃèÊö: Uart¶Á
  22          // ²ÎÊı: *buf: ·¢ËÍµÄÊı¾İ ,len:³¤¶È
  23          // ·µ»Ø: ³¤¶È
  24          // °æ±¾: V1.0, 2017-9-23
  25          //========================================================================
  26          
  27          unsigned char UartRead(unsigned char *buf, unsigned char len) 
  28          {
  29   1          unsigned char i;
  30   1          
  31   1          if (len > cntRxd)       //¶ÁÈ¡³¤¶È´óÓÚ½ÓÊÕÊı¾İ³¤¶È
  32   1          {
  33   2              len = cntRxd;       //¶ÁÈ¡³¤¶ÈÉèÖÃÎªÊµ¼Ê½ÓÊÕµ½µÄÊı¾İ³¤¶È
  34   2          }
  35   1          for (i=0; i<len; i++)   //¿½±´½ÓÊÕµ½µÄÊı¾İ
  36   1          {
  37   2              *buf = bufRxd[i];
  38   2              buf++;
  39   2          }
  40   1          cntRxd = 0;             //Çå0½ÓÊÕ¼ÆÊıÆ÷
  41   1          
  42   1          return len;             //·µ»ØÊµ¼Ê¶ÁÈ¡µÄ³¤¶È
  43   1      }
  44          
  45          //========================================================================
  46          // º¯Êı: void UartWrite(unsigned char *buf, unsigned char len)
  47          // ÃèÊö: UartĞ´
  48          // ²ÎÊı: *buf: Êı¾İ ,len:³¤¶È
  49          // ·µ»Ø: 
  50          // °æ±¾: V1.0, 2017-9-23
  51          //========================================================================
  52          void UartWrite(unsigned char *buf, unsigned char len) 
  53          {
  54   1        
C51 COMPILER V9.55   UART                                                                  04/30/2021 14:43:20 PAGE 2   

  55   1          while (len--)           //·¢ËÍÊı¾İ
  56   1          {
  57   2              flagOnceTxd = 0;
  58   2              SBUF = *buf;
  59   2              buf++;
  60   2              while(!flagOnceTxd);
  61   2          }
  62   1      }
  63          
  64          //========================================================================
  65          // º¯Êı: void Uart1RxMonitor(unsigned char ms)
  66          // ÃèÊö: Uart½ÓÊÕÊı¾İ¼à¿Øº¯Êı
  67          // ²ÎÊı: ms:³¬Ê±Ê±¼ä
  68          // ·µ»Ø: 
  69          // °æ±¾: V1.0, 2017-9-23
  70          //========================================================================
  71          void Uart1RxMonitor(unsigned char ms)  
  72          {
  73   1          static unsigned char cntbkp = 0;
  74   1          static unsigned char idletmr = 0;
  75   1      
  76   1          if (cntRxd > 0)                   //½ÓÊÕ¼ÆÊıÆ÷´óÓÚ0Ê±£¬¼à¿Ø×ÜÏß¿ÕÏĞÊ±¼äÕ
  77   1          {
  78   2              if (cntbkp != cntRxd)         //½ÓÊÕ¼ÆÊıÆ÷·¢Éú¸Ä±ä£¬¼´½ÓÊÕµ½Êı¾İ£¬Çå0¿ÕÏĞ¼ÆÊ±
  79   2              {
  80   3                  cntbkp = cntRxd;
  81   3                  idletmr = 0;
  82   3              }
  83   2              else
  84   2              {
  85   3                  if(idletmr < 5)         //½ÓÊÕ¼ÆÊıÆ÷Î´¸Ä±ä£¬¼´×ÜÏß¿ÕÏĞ£¬ÀÛ¼Æ¿ÕÏĞÊ±¼ä
  86   3                  {
  87   4                      idletmr += ms;
  88   4                      if (idletmr >= 5)     //¿ÕÏĞÊ±¼ä³¬Ê±5ms
  89   4                      {
  90   5                          cmdArrived = 1;   //½ÓÊÕÊı¾İ½áÊø
  91   5                      }
  92   4                  }
  93   3              }
  94   2          }
  95   1          else
  96   1          {
  97   2              cntbkp = 0;
  98   2          }
  99   1      }
 100          
 101          void Uart() interrupt 4 using 3
 102          {
 103   1          if(RI)
 104   1          {
 105   2              RI = 0;
 106   2              if (cntRxd < sizeof(bufRxd))      //½ÓÊÕ»º³åÇøÃ»ÓĞÓÃÍê
 107   2              {
 108   3                  bufRxd[cntRxd++] = SBUF;      //±£´æ½ÓÊÕµ½Êı¾İ£¬²¢µİÔö¼ÆÊıÆ÷
 109   3              }
 110   2          }
 111   1          if (TI)
 112   1          {
 113   2              TI = 0;                           
 114   2              flagOnceTxd = 1;                  //µ¥´Î·¢ËÍÍê³É
 115   2          }   
 116   1      }
C51 COMPILER V9.55   UART                                                                  04/30/2021 14:43:20 PAGE 3   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    188    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     80    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
